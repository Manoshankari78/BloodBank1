<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - LifeLine Connect</title>
  <link rel="stylesheet" href="/assets/css/styles.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to bottom, #f2f2ff, #e6e6ff);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    .btn {
      background: #b30000;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .btn:hover {
      background: #800000;
    }
  </style>
</head>
<body>
  <header class="bg-red-600 text-white py-4 px-6 w-full text-center">
    <h1 class="text-2xl font-bold">LifeLine Connect Dashboard</h1>
    <button id="logout" class="btn mt-2">Logout</button>
  </header>
  <div class="container">
    <h2 id="welcome" class="text-xl font-semibold text-red-700 mb-4"></h2>
    <div id="donor-actions" class="hidden">
      <h3 class="text-lg font-semibold mb-2">Donor Actions</h3>
      <form id="donation-form" class="space-y-4">
        <input type="date" name="donation_date" required class="border p-2 w-full">
        <input type="text" name="location" placeholder="Location" required class="border p-2 w-full">
        <button type="submit" class="btn">Schedule Donation</button>
      </form>
      <h3 class="text-lg font-semibold mt-4 mb-2">Search Blood</h3>
      <form id="search-form" class="space-y-4">
        <select name="blood_group" required class="border p-2 w-full">
          <option value="">Select Blood Group</option>
          <option value="A+">A+</option>
          <option value="A-">A-</option>
          <option value="B+">B+</option>
          <option value="B-">B-</option>
          <option value="AB+">AB+</option>
          <option value="AB-">AB-</option>
          <option value="O+">O+</option>
          <option value="O-">O-</option>
        </select>
        <button type="submit" class="btn">Search</button>
      </form>
      <div id="search-results" class="mt-4"></div>
    </div>
    <div id="recipient-actions" class="hidden">
      <h3 class="text-lg font-semibold mb-2">Recipient Actions</h3>
      <form id="request-form" class="space-y-4">
        <select name="blood_group" required class="border p-2 w-full">
          <option value="">Select Blood Group</option>
          <option value="A+">A+</option>
          <option value="A-">A-</option>
          <option value="B+">B+</option>
          <option value="B-">B-</option>
          <option value="AB+">AB+</option>
          <option value="AB-">AB-</option>
          <option value="O+">O+</option>
          <option value="O-">O-</option>
        </select>
        <input type="number" name="quantity" placeholder="Quantity (units)" required class="border p-2 w-full">
        <button type="submit" class="btn">Request Blood</button>
      </form>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
  const user = JSON.parse(localStorage.getItem('user'));
  if (!user) {
    window.location.href = '/login.html';
    return;
  }

  const welcome = document.getElementById('welcome');
  const donorActions = document.getElementById('donor-actions');
  const recipientActions = document.getElementById('recipient-actions');

  if (user.role === 'donor') {
    welcome.textContent = 'Welcome, Donor!';
    donorActions.classList.remove('hidden');

    // Fetch donor's blood group
    try {
      const res = await fetch(`/api/users/donor/${user.id}`);
      const donor = await res.json();
      console.log('Donor profile response:', donor); // Debug: Show donor profile response
      if (!res.ok) throw new Error(donor.message || 'Failed to fetch donor profile');
      const bloodGroup = donor.blood_group;

      // Schedule Donation
      document.getElementById('donation-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('Donation form submitted'); // Debug: Confirm event fires
        const formData = new FormData(e.target);
        const data = {
          donor_id: user.id,
          blood_group: bloodGroup,
          quantity: 1,
          donation_date: formData.get('donation_date'),
          location: formData.get('location')
        };
        console.log('Donation data sent:', data); // Debug: Show sent data

        try {
          const res = await fetch('/api/users/donations', { // Ensure correct endpoint
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          const result = await res.json();
          console.log('Donation server response:', result); // Debug: Show response
          alert(result.message);
          if (res.ok) e.target.reset();
        } catch (error) {
          console.error('Donation fetch error:', error); // Debug: Catch errors
          alert('Failed to schedule donation. Please try again.');
        }
      });

      // Search Blood
      document.getElementById('search-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('Search form submitted'); // Debug: Confirm event fires
        const blood_group = new FormData(e.target).get('blood_group');
        console.log('Search blood group:', blood_group); // Debug: Show blood group

        try {
          const res = await fetch(`/api/users/inventory?blood_group=${blood_group}`); // Ensure correct endpoint
          const result = await res.json();
          console.log('Search server response:', result); // Debug: Show response
          const resultsDiv = document.getElementById('search-results');
          resultsDiv.innerHTML = result.quantity > 0
            ? `Available: ${result.quantity} units of ${blood_group}`
            : `No ${blood_group} blood available.`;
        } catch (error) {
          console.error('Search fetch error:', error); // Debug: Catch errors
          alert('Failed to search blood. Please try again.');
        }
      });
    } catch (error) {
      console.error('Donor profile fetch error:', error);
      alert('Failed to load donor profile. Please log in again.');
      window.location.href = '/login.html';
    }
  } else {
    welcome.textContent = 'Welcome, Recipient!';
    recipientActions.classList.remove('hidden');

    document.getElementById('request-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      console.log('Request form submitted');
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      console.log('Request form data:', data);
      const requestData = {
        recipient_id: user.id,
        blood_group: data.blood_group,
        quantity: parseInt(data.quantity)
      };
      console.log('Request data sent:', requestData);

      try {
        const res = await fetch('/api/users/requests', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestData)
        });

        const result = await res.json();
        console.log('Server response:', result);
        alert(result.message);
        if (res.ok) e.target.reset();
      } catch (error) {
        console.error('Fetch error:', error);
        alert('Failed to request blood. Please try again.');
      }
    });
  }
  document.getElementById('search-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const blood_group = new FormData(e.target).get('blood_group');
    const res = await fetch(`/api/inventory?blood_group=${blood_group}`);
    const result = await res.json();
    const resultsDiv = document.getElementById('search-results');
    resultsDiv.innerHTML = result.quantity > 0
      ? `Available: ${result.quantity} units of ${blood_group}`
      : `No ${blood_group} blood available.`;
  });

  document.getElementById('logout').addEventListener('click', () => {
    localStorage.removeItem('user');
    window.location.href = '/login.html';
  });
});
  </script>
</body>
</html>